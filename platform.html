<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>E-Noer Auto Platform</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      referrerpolicy="no-referrer"
    />

    <style>
      :root{
        --bg:#f5f6f8; --panel:#ffffff; --muted:#6b7280; --ink:#0f172a;
        --brand:#ff5a1f; --success:#16a34a; --ring: 0 0 0 3px rgba(31,143,255,.2);
      }
      .scroll-slim::-webkit-scrollbar{height:8px;width:8px}
      .scroll-slim::-webkit-scrollbar-thumb{background:#e5e7eb;border-radius:999px}
      .kv{display:grid;grid-template-columns:160px 1fr;gap:.4rem 1rem;font-size:.95rem}
      .kv .label{color:var(--muted);font-weight:700}
      .badge{display:inline-flex;align-items:center;gap:.4rem;padding:.30rem .55rem;border-radius:999px;font-size:.72rem;font-weight:700}
      .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:.6rem;padding:.55rem .85rem;border:1px solid #e5e7eb;background:#fff}
      .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}
      .panel{background:var(--panel);border:1px solid #e5e7eb;border-radius:.75rem;padding:1rem}
      pre.json {max-height:320px;overflow:auto;background:#0b1220;color:#dff1ff;padding:1rem;border-radius:.5rem;font-size:12px}
    </style>

    <!-- IMPORTANT: load env.js from your Express server (3001) -->
    <script src="http://localhost:3001/env.js"></script>
  </head>

  <body class="min-h-screen bg-[var(--bg)] text-[var(--ink)]">
    <div class="max-w-7xl mx-auto py-8 px-4">
      <header class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold">E-Noer — RDW voertuigopvraag</h1>
        <div>
          <a href="/" class="btn"><i class="fa-solid fa-house"></i> Home</a>
        </div>
      </header>

      <section class="grid gap-4 mb-6">
        <div class="panel">
          <div class="flex gap-3 items-center">
            <input id="kenteken" placeholder="Bijv. SX348F" class="ring-focus px-3 py-2 border rounded-lg w-56 uppercase" inputmode="latin" />
            <button id="fetchRDW" class="btn btn-primary"><i class="fa-solid fa-magnifying-glass"></i> Ophalen</button>
            <button id="clearBtn" class="btn"><i class="fa-solid fa-eraser"></i> Wissen</button>
            <div id="status" class="ml-4 text-sm text-gray-600"></div>
          </div>
          <div id="rdwPreview" class="mt-4 hidden">
            <div class="kv" id="rdwKV"></div>
          </div>
        </div>

        <div id="fullDetails" class="hidden space-y-4">
          <div class="panel">
            <div class="text-sm text-gray-500 mb-2">Samenvatting (summary)</div>
            <div class="kv" id="summaryKV"></div>
          </div>

          <div class="grid lg:grid-cols-2 gap-4">
            <div class="panel">
              <div class="text-sm text-gray-500 mb-2">Basisgegevens (details.basis)</div>
              <div id="detailsBasis" class="kv"></div>
            </div>

            <div class="panel">
              <div class="text-sm text-gray-500 mb-2">Technische arrays</div>

              <div class="mb-4">
                <div class="font-semibold mb-1">Brandstoffen</div>
                <div id="detailsBrandstoffen" class="space-y-2 text-sm"></div>
              </div>

              <div class="mb-4">
                <div class="font-semibold mb-1">Kleuren</div>
                <div id="detailsKleuren" class="space-y-2 text-sm"></div>
              </div>

              <div class="mb-4">
                <div class="font-semibold mb-1">Carrosserie</div>
                <div id="detailsCarrosserie" class="space-y-2 text-sm"></div>
              </div>

              <div>
                <div class="font-semibold mb-1">Assen</div>
                <div id="detailsAssen" class="space-y-2 text-sm"></div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-500">Raw / volledig (debug)</div>
              <div>
                <button id="toggleRaw" class="btn">Toon / Verberg JSON</button>
              </div>
            </div>
            <div id="rawContainer" class="mt-3 hidden">
              <pre id="rawJson" class="json"></pre>
            </div>
          </div>
        </div>

        <div id="toast" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg border bg-white shadow"></div>
      </section>
    </div>

    <script type="module">
      // Config
      const API_BASE = "http://localhost:3001";
      const $ = (q, root = document) => root.querySelector(q);
      const $$ = (q, root = document) => [...root.querySelectorAll(q)];
      const toastEl = $('#toast');
      function toast(msg, time = 2200) {
        toastEl.textContent = msg;
        toastEl.classList.remove('hidden');
        setTimeout(()=> toastEl.classList.add('hidden'), time);
      }

      // UI refs
      const rdwPreview = $('#rdwPreview');
      const rdwKV = $('#rdwKV');
      const summaryKV = $('#summaryKV');
      const detailsBasis = $('#detailsBasis');
      const detailsBrandstoffen = $('#detailsBrandstoffen');
      const detailsKleuren = $('#detailsKleuren');
      const detailsCarrosserie = $('#detailsCarrosserie');
      const detailsAssen = $('#detailsAssen');
      const fullDetails = $('#fullDetails');
      const rawJsonEl = $('#rawJson');
      const rawContainer = $('#rawContainer');
      const status = $('#status');

      let lastRaw = null;

      async function fetchRDW(kenteken) {
        const res = await fetch(`${API_BASE}/api/rdw?kenteken=${encodeURIComponent(kenteken)}`);
        if(!res.ok) {
          const body = await res.json().catch(()=>({error:'unknown'}));
          throw new Error(body.error || body.detail || `RDW proxy ${res.status}`);
        }
        return res.json();
      }

      function kvAppend(container, label, value){
        const k = document.createElement('div'); k.className='label'; k.textContent = label;
        const v = document.createElement('div'); v.textContent = (value === null || value === undefined || value === '') ? '—' : String(value);
        container.append(k, v);
      }

      $('#fetchRDW').addEventListener('click', async ()=>{
        const kent = $('#kenteken').value.trim().replace(/-/g,'').toUpperCase();
        if(!kent) { toast('Vul een kenteken in'); return; }

        try{
          status.textContent = 'Ophalen…';
          const data = await fetchRDW(kent);
          lastRaw = data;
          // Summary quick preview
          rdwKV.innerHTML = '';
          const s = data.summary || {};
          const pairs = {
            'Kenteken': s.kenteken || kent,
            'Merk': s.merk || '-',
            'Handelsbenaming': s.handelsbenaming || '-',
            'Bouwjaar': s.bouwjaar || '-',
            'Brandstof': s.brandstof || '-',
            'Kleur': s.kleur || '-',
            'APK tot': s.apk_vervaldatum || '-'
          };
          Object.entries(pairs).forEach(([k,v]) => kvAppend(rdwKV, k, v));
          rdwPreview.classList.remove('hidden');

          // Full details sections
          summaryKV.innerHTML = '';
          const summary = data.summary || {};
          Object.entries(summary).forEach(([k,v]) => kvAppend(summaryKV, k.replace(/_/g,' '), v));

          // Basis
          detailsBasis.innerHTML = '';
          const basis = (data.details && data.details.basis) ? data.details.basis : {};
          // show all keys in basis
          Object.entries(basis).forEach(([k,v]) => kvAppend(detailsBasis, k.replace(/_/g,' '), v));

          // brandstoffen
          detailsBrandstoffen.innerHTML = '';
          (data.details?.brandstoffen || []).forEach((b, idx) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'border rounded p-2';
            wrapper.innerHTML = `<div class="text-sm font-semibold">Brandstof ${idx+1}: ${b.omschrijving || '—'}</div>`;
            const inner = document.createElement('div');
            inner.className = 'kv mt-2';
            Object.entries(b).forEach(([k,v]) => {
              const label = k.replace(/_/g,' ');
              kvAppend(inner, label, v);
            });
            wrapper.append(inner);
            detailsBrandstoffen.append(wrapper);
          });
          if((data.details?.brandstoffen || []).length === 0) {
            detailsBrandstoffen.textContent = 'Geen brandstofrecords';
          }

          // kleuren
          detailsKleuren.innerHTML = '';
          (data.details?.kleuren || []).forEach((c, idx) => {
            const row = document.createElement('div');
            row.className = 'kv';
            kvAppend(row, 'Eerste kleur', c.eerste_kleur || '');
            kvAppend(row, 'Tweede kleur', c.tweede_kleur || '');
            detailsKleuren.append(row);
          });
          if((data.details?.kleuren || []).length === 0) detailsKleuren.textContent = 'Geen kleurrecords';

          // carrosserie
          detailsCarrosserie.innerHTML = '';
          (data.details?.carrosserie || []).forEach(c => {
            const row = document.createElement('div'); row.className='kv';
            kvAppend(row, 'Volgnummer', c.carrosserie_volgnummer ?? '');
            kvAppend(row, 'Omschrijving', c.carrosserietype_omschrijving ?? '');
            detailsCarrosserie.append(row);
          });
          if((data.details?.carrosserie || []).length === 0) detailsCarrosserie.textContent = 'Geen carrosserierecords';

          // carrosserie specifieks
          if((data.details?.carrosserie_specifiek || []).length > 0){
            const header = document.createElement('div'); header.className='font-semibold mt-3'; header.textContent='Carrosserie (specifiek)';
            detailsCarrosserie.append(header);
            (data.details.carrosserie_specifiek || []).forEach(c => {
              const row = document.createElement('div'); row.className='kv';
              kvAppend(row, 'Volgnummer', c.carrosserie_volgnummer ?? '');
              kvAppend(row, 'Omschrijving', c.carrosserietype_omschrijving ?? '');
              detailsCarrosserie.append(row);
            });
          }

          // assen
          detailsAssen.innerHTML = '';
          (data.details?.assen || []).forEach(a => {
            const row = document.createElement('div'); row.className='kv';
            Object.entries(a).forEach(([k,v]) => kvAppend(row, k.replace(/_/g,' '), v));
            detailsAssen.append(row);
          });
          if((data.details?.assen || []).length === 0) detailsAssen.textContent = 'Geen asrecords';

          // raw JSON
          rawJsonEl.textContent = JSON.stringify(data, null, 2);
          fullDetails.classList.remove('hidden');

          status.textContent = '';
          toast('RDW-gegevens geladen', 1500);

        } catch (err) {
          status.textContent = '';
          console.error(err);
          const msg = err?.message || 'Ophalen mislukt';
          toast(msg, 3000);
        }
      });

      $('#clearBtn').addEventListener('click', ()=>{
        $('#kenteken').value='';
        rdwKV.innerHTML=''; rdwPreview.classList.add('hidden');
        summaryKV.innerHTML=''; detailsBasis.innerHTML=''; detailsBrandstoffen.innerHTML=''; detailsKleuren.innerHTML=''; detailsCarrosserie.innerHTML=''; detailsAssen.innerHTML='';
        fullDetails.classList.add('hidden');
        rawJsonEl.textContent='';
        lastRaw = null;
      });

      $('#toggleRaw').addEventListener('click', ()=>{
        rawContainer.classList.toggle('hidden');
      });

      // Support Enter key on kenteken input
      $('#kenteken').addEventListener('keydown', (e)=>{
        if(e.key === 'Enter') { e.preventDefault(); $('#fetchRDW').click(); }
      });
    </script>
  </body>
</html>