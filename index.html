<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProDriveNet — Dealerplatform</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer" />
  <!-- Exposes window.__SUPABASE_URL__ and window.__SUPABASE_ANON_KEY__ -->
  <script src="/env.js"></script>
  <style>
    .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:.6rem;padding:.55rem .85rem;border:1px solid #e5e7eb;background:#fff}
    .btn-primary{background:#ff5a1f;border-color:#ff5a1f;color:#fff}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);padding:.6rem .9rem;border:1px solid #e5e7eb;background:#fff;border-radius:.6rem;box-shadow:0 6px 24px rgba(0,0,0,.08);display:none}
    .toast.show{display:block}
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <!-- Top bar -->
  <header class="h-14 backdrop-blur bg-white/80 border-b sticky top-0 z-10">
    <div class="max-w-6xl mx-auto h-full flex items-center justify-between px-4">
      <div class="flex items-center gap-2">
        <span class="inline-flex w-2.5 h-2.5 rounded-full bg-orange-500"></span>
        <span class="font-extrabold tracking-tight">ProDriveNet</span>
      </div>
      <nav class="flex items-center gap-2">
        <a id="btnGoPlatform" href="/platform.html" class="btn hidden"><i class="fa-solid fa-gauge"></i> Naar platform</a>
        <button id="btnOpenAuth" class="btn btn-primary"><i class="fa-regular fa-user"></i> Inloggen / Registreren</button>
      </nav>
    </div>
  </header>

  <!-- Hero -->
  <main class="max-w-6xl mx-auto px-4 py-12">
    <div class="grid lg:grid-cols-2 gap-10 items-center">
      <section>
        <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">Alles voor je <span class="text-orange-500">verkoop</span> — één platform</h1>
        <p class="mt-4 text-slate-600 leading-7">
          Importeer RDW-gegevens, beheer voertuigen, stel advertenties samen en publiceer sneller.
        </p>
        <div class="mt-6 flex gap-3">
          <a href="/platform.html" class="btn btn-primary" id="ctaStart">Start meteen</a>
          <button class="btn" id="ctaAuth">Inloggen / Registreren</button>
        </div>
        <ul class="mt-8 space-y-2 text-slate-600">
          <li>• RDW-koppeling en voertuigkaart</li>
          <li>• Verkoopoverzicht met fotobeheer</li>
          <li>• Supabase-auth en data</li>
        </ul>
      </section>

      <aside class="bg-white border rounded-2xl p-6 shadow-sm">
        <div class="text-sm text-slate-500 mb-2">Snel overzicht</div>
        <div class="grid grid-cols-3 gap-3 text-center">
          <div class="p-4 rounded-xl border">
            <div class="text-2xl font-extrabold">26</div>
            <div class="text-xs text-slate-500">Actieve auto’s</div>
          </div>
          <div class="p-4 rounded-xl border">
            <div class="text-2xl font-extrabold">3</div>
            <div class="text-xs text-slate-500">Verkocht</div>
          </div>
          <div class="p-4 rounded-xl border">
            <div class="text-2xl font-extrabold">781</div>
            <div class="text-xs text-slate-500">Archief</div>
          </div>
        </div>
        <div class="mt-6 text-center text-xs text-slate-400">Demo-data</div>
      </aside>
    </div>
  </main>

  <!-- Auth modal mount -->
  <div id="authMount"></div>
  <div id="toast" class="toast"></div>

  <script type="module">
    const toast = (msg)=>{ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('show'),2200); };

    // --- Try to show "Naar platform" if session exists (non-blocking)
    (async()=>{
      try{
        const { createClient } = await import("https://esm.sh/@supabase/supabase-js@2");
        if(!window.__SUPABASE_URL__ || !window.__SUPABASE_ANON_KEY__) return;
        const s = createClient(window.__SUPABASE_URL__, window.__SUPABASE_ANON_KEY__);
        const { data:{ session } } = await s.auth.getSession();
        document.getElementById('btnGoPlatform')?.classList.toggle('hidden', !session);
      }catch{ /* ignore */ }
    })();

    async function ensureAuthModalLoaded(){
      if (document.getElementById('authDialog')) return true;
      const mount = document.getElementById('authMount');
      const paths = ['/partials/auth-modal.html','partials/auth-modal.html'];
      let ok=false,lastErr=null;
      for (const p of paths){
        try{
          const r = await fetch(p, { cache:'no-store' });
          if(!r.ok) throw new Error(`HTTP ${r.status}`);
          mount.innerHTML = await r.text();
          ok=true; break;
        }catch(e){ lastErr=e; }
      }
      if(!ok){
        console.error('Auth partial failed to load', lastErr);
        toast('Kon inlogvenster niet laden');
        return false;
      }
      bindAuthHandlers();
      return true;
    }

    function bindAuthHandlers(){
      const dlg = document.getElementById('authDialog');
      document.getElementById('authClose')?.addEventListener('click', ()=> dlg.close());

      // Wire Supabase if env is present
      (async()=>{
        try{
          const { createClient } = await import("https://esm.sh/@supabase/supabase-js@2");
          if(!window.__SUPABASE_URL__ || !window.__SUPABASE_ANON_KEY__){
            document.getElementById('authMsg').textContent = 'Supabase env ontbreekt (env.js).';
            return;
          }
          const supabase = createClient(window.__SUPABASE_URL__, window.__SUPABASE_ANON_KEY__);

          const providers = ['google','github','apple'];
          providers.forEach(p=>{
            document.getElementById('btn-'+p)?.addEventListener('click', async ()=>{
              const redirectTo = `${location.origin}/platform.html`;
              const { error } = await supabase.auth.signInWithOAuth({ provider:p, options:{ redirectTo } });
              if(error) document.getElementById('authMsg').textContent = error.message;
            });
          });

          document.getElementById('emailForm')?.addEventListener('submit', async (e)=>{
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const { error } = await supabase.auth.signInWithOtp({ email, options:{ emailRedirectTo:`${location.origin}/platform.html` }});
            document.getElementById('authMsg').textContent = error ? error.message : 'Check je mail voor de login link.';
          });
        }catch(e){
          console.error(e);
          document.getElementById('authMsg').textContent = 'Kon Supabase niet initialiseren.';
        }
      })();

      // Expose opener
      window.__openAuth = ()=> dlg.showModal();
    }

    async function openAuth(){
      const ok = await ensureAuthModalLoaded();
      if(ok) window.__openAuth();
    }

    // Buttons
    document.getElementById('btnOpenAuth')?.addEventListener('click', openAuth);
    document.getElementById('ctaAuth')?.addEventListener('click', openAuth);

    // If user clicks "Start meteen" but isn’t logged in, open modal instead of navigating
    document.getElementById('ctaStart')?.addEventListener('click', async (e)=>{
      try{
        const { createClient } = await import("https://esm.sh/@supabase/supabase-js@2");
        if(!window.__SUPABASE_URL__ || !window.__SUPABASE_ANON_KEY__){ e.preventDefault(); return openAuth(); }
        const s = createClient(window.__SUPABASE_URL__, window.__SUPABASE_ANON_KEY__);
        const { data:{ session } } = await s.auth.getSession();
        if(!session){ e.preventDefault(); openAuth(); }
      }catch{ e.preventDefault(); openAuth(); }
    });
  </script>
</body>
</html>